# 教授卡片关联显示功能实现

## 🎯 功能需求
用户希望每次新问题的教授卡片显示在对应回答的下面，形成：
```
问题1 → 回答1 → 教授卡片1 → 问题2 → 回答2 → 教授卡片2
```

## 🔧 技术实现

### 1. 数据结构调整
**之前**: 全局 `teacherCards` 数组存储所有教授卡片
```javascript
data: {
  messages: [],
  teacherCards: [] // 全局教授卡片
}
```

**现在**: 每个助手消息包含自己的教授卡片
```javascript
data: {
  messages: [
    {
      id: '1',
      type: 'assistant',
      content: '回答内容',
      teacherCards: [] // 该回答对应的教授卡片
    }
  ]
}
```

### 2. WXML结构重构
**之前**: 消息和教授卡片分离显示
```xml
<!-- 所有消息 -->
<view wx:for="{{messages}}">...</view>
<!-- 所有教授卡片 -->
<view wx:for="{{teacherCards}}">...</view>
```

**现在**: 消息和教授卡片关联显示
```xml
<view wx:for="{{messages}}" class="message-container">
  <!-- 消息内容 -->
  <view class="message">{{item.content}}</view>
  
  <!-- 该消息对应的教授卡片 -->
  <view wx:if="{{item.teacherCards}}" class="message-teachers">
    <view wx:for="{{item.teacherCards}}" wx:for-item="teacher">
      <!-- 教授卡片内容 -->
    </view>
  </view>
</view>
```

### 3. 核心逻辑修改

#### 消息创建
```javascript
const assistantMessage = {
  id: (Date.now() + 1).toString(),
  type: 'assistant',
  content: res.message,
  teacherCards: [] // 初始化教授卡片数组
};
```

#### 教授卡片关联
```javascript
async showTeacherRecommendations(apiResponse, messageId) {
  // 处理教授数据...
  const teachers = [...];
  
  // 找到对应消息并更新教授卡片
  const messages = [...this.data.messages];
  const messageIndex = messages.findIndex(msg => msg.id === messageId);
  messages[messageIndex].teacherCards = teachers;
  
  this.setData({ messages });
}
```

#### 辅助方法
```javascript
// 获取所有教授卡片（用于搜索、分享等功能）
getAllTeacherCards() {
  const allTeachers = [];
  this.data.messages.forEach(message => {
    if (message.teacherCards && message.teacherCards.length > 0) {
      allTeachers.push(...message.teacherCards);
    }
  });
  return allTeachers;
}
```

## 🎨 样式调整

### 新增CSS类
```css
/* 消息容器 - 包含消息和对应的教授卡片 */
.message-container {
  width: 100%;
  margin-bottom: 20rpx;
}

/* 该消息对应的教师卡片容器 */
.message-teachers {
  margin-top: 20rpx;
  padding-left: 30rpx;
  padding-right: 30rpx;
}
```

## 📱 用户体验

### 显示效果
```
👤 用户：推荐一些AI方向的教授
🤖 助手：以下是AI方向的优秀教授推荐...
    📋 [张三教授 - 人工智能]
    📋 [李四教授 - 机器学习]

👤 用户：有没有计算机视觉的专家？
🤖 助手：为您推荐计算机视觉领域的专家...
    📋 [王五教授 - 计算机视觉]
    📋 [赵六教授 - 图像处理]
```

### 功能优势
- ✅ **关联清晰**: 每个回答的教授推荐紧跟在回答后面
- ✅ **上下文明确**: 用户知道哪些教授是针对哪个问题推荐的
- ✅ **历史保持**: 所有问答和教授推荐都保持在对话历史中
- ✅ **兼容现有功能**: 选择、复制、分享功能正常工作

## 🔄 向后兼容

处理旧版本会话数据：
```javascript
// 加载会话时自动适配旧格式
if (conversation.teacherCards) {
  // 将旧的全局教授卡片迁移到最后一条助手消息
  const lastMessage = conversation.messages[conversation.messages.length - 1];
  if (lastMessage && lastMessage.type === 'assistant') {
    lastMessage.teacherCards = conversation.teacherCards;
  }
}
```

现在教授卡片会按照对话顺序显示在对应的回答下面！
