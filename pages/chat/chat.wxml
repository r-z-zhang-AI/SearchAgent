<!-- pages/chat/chat.wxml - æŒ‰ç…§è®¾è®¡ç¨¿é‡æ–°è®¾è®¡ -->
<view class="page {{showActionBar ? 'selection-mode' : ''}}">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="navbar">
    <view class="nav-left">
      <text class="menu-icon" bindtap="showConversationHistory">â˜°</text>
      <text class="add-icon" bindtap="startNewConversation">+</text>
    </view>
    <text class="nav-title">{{conversationTitle}}</text>
    <view class="nav-right">
      <!-- åˆ é™¤è°ƒè¯•æŒ‰é’® -->
    </view>
  </view>

  <!-- èŠå¤©å®¹å™¨ -->
  <view class="chat-container">
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <scroll-view class="messages" scroll-y="true" scroll-into-view="{{scrollIntoView}}" bindtap="onMessagesAreaTap">

      <!-- æ¬¢è¿æ¶ˆæ¯ -->
      <view wx:if="{{messages.length === 0}}" class="welcome-message">
        <text class="welcome-text">æ‚¨å¥½ï¼æˆ‘æ˜¯æµ™å¤§æ™ºèƒ½ç§‘ç ”åŒ¹é…åŠ©æ‰‹ï¼Œæˆ‘ä»¬å…ˆä»å“ªé‡Œå¼€å§‹å‘¢ï¼Ÿ</text>
      </view>

      <!-- æ€è€ƒæ—¶é—´æç¤º -->
      <view wx:if="{{showThinkingTime}}" class="thinking-indicator">
        <view class="thinking-content">
          <view class="thinking-icon">ğŸ¤”</view>
          <text class="thinking-text">æ­£åœ¨æ€è€ƒä¸­...é¢„è®¡è¿˜éœ€ {{thinkingCountdown}} ç§’</text>
        </view>
        <view class="thinking-progress">
          <view class="thinking-progress-bar" style="width: {{((thinkingTime - thinkingCountdown) / thinkingTime * 100)}}%"></view>
        </view>
      </view>

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <view wx:for="{{messages}}" wx:key="id" class="message-container">
        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message {{item.type}} {{selectedMessages.includes(item.id) ? 'selected' : ''}}"
              bindlongpress="onMessageLongPress" data-id="{{item.id}}" data-type="message">

          <!-- é€‰æ‹©æ¡† -->
          <view wx:if="{{showActionBar}}" class="selection-checkbox {{selectedMessages.includes(item.id) ? 'checked' : ''}}"
                bindtap="toggleMessageSelection" data-id="{{item.id}}">
            <image wx:if="{{selectedMessages.includes(item.id)}}" class="checkbox-icon" src="/images/tick.svg" mode="aspectFit"></image>
          </view>

          <view class="message-wrapper">
            <view class="message-content">
              {{item.content}}
              <text wx:if="{{item.isStreaming}}" class="typing-cursor">|</text>
            </view>
            
            <!-- AIå›ç­”çš„æ“ä½œæŒ‰é’® -->
            <view wx:if="{{item.type === 'assistant' && item.showActions}}" class="message-actions">
              <image class="action-icon regenerate-icon" src="/images/start-over.svg" mode="aspectFit"
                     bindtap="regenerateAnswer" data-id="{{item.id}}"></image>
              <image class="action-icon continue-icon" src="/images/continue.svg" mode="aspectFit"
                     bindtap="continueAnswer" data-id="{{item.id}}"></image>
            </view>
          </view>
        </view>

        <!-- è¯¥æ¶ˆæ¯å¯¹åº”çš„æ•™å¸ˆå¡ç‰‡ -->
        <view wx:if="{{item.teacherCards && item.teacherCards.length > 0}}" class="message-teachers">
          <view wx:for="{{item.teacherCards}}" wx:for-item="teacher" wx:key="id" 
                class="teacher-card {{selectedMessages.includes('teacher-' + teacher.id) ? 'selected' : ''}}"
                bindlongpress="onMessageLongPress" data-id="{{'teacher-' + teacher.id}}" data-type="teacher">

            <!-- é€‰æ‹©æ¡† -->
            <view wx:if="{{showActionBar}}" class="selection-checkbox {{selectedMessages.includes('teacher-' + teacher.id) ? 'checked' : ''}}"
                  bindtap="toggleMessageSelection" data-id="{{'teacher-' + teacher.id}}">
              <image wx:if="{{selectedMessages.includes('teacher-' + teacher.id)}}" class="checkbox-icon" src="/images/tick.svg" mode="aspectFit"></image>
            </view>

            <view class="teacher-header">
              <view class="teacher-basic">
                <text class="teacher-name">{{teacher.name}}</text>
                <text class="teacher-title">{{teacher.title}}</text>
              </view>
              <view class="teacher-actions">
                <image class="star-icon {{teacher.isFavorited ? 'favorited' : ''}}" 
                       src="/images/star.svg" 
                       mode="aspectFit"
                       bindtap="toggleTeacherFavorite" 
                       data-teacher-id="{{teacher.id}}"></image>
                <image class="share-icon" 
                       src="/images/share.svg" 
                       mode="aspectFit"
                       bindtap="shareTeacher" 
                       data-teacher-id="{{teacher.id}}"></image>
              </view>
            </view>

            <view class="teacher-content">
              <view class="teacher-info-grid">
                <view class="info-item">
                  <text class="info-label">ç ”ç©¶æ–¹å‘:</text>
                  <text class="info-value">{{teacher.research}}</text>
                </view>
                <view class="info-item">
                  <text class="info-label">æ‰€å±å­¦é™¢:</text>
                  <text class="info-value">{{teacher.department}}</text>
                </view>
                <view class="info-item">
                  <text class="info-label">è”ç³»é‚®ç®±:</text>
                  <text class="info-value">{{teacher.email}}</text>
                </view>
                <view class="info-item">
                  <text class="info-label">åŠå…¬åœ°ç‚¹:</text>
                  <text class="info-value">{{teacher.office}}</text>
                </view>
              </view>

              <view wx:if="{{teacher.achievements}}" class="teacher-achievements">
                <text class="achievements-title">ä¸»è¦æˆå°±:</text>
                <view class="achievements-list">
                  <text wx:for="{{teacher.achievements}}" wx:key="*this" class="achievement-item">â€¢ {{item}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ»šåŠ¨é”šç‚¹ -->
      <view id="messagesEndRef"></view>
    </scroll-view>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <view class="input-area {{showActionBar ? 'with-action-bar' : ''}}">
      <view class="input-container">
        <input
          class="message-input"
          placeholder="è¯·æè¿°æ‚¨çš„éœ€æ±‚......"
          value="{{inputValue}}"
          bindinput="onInputChange"
          bindconfirm="sendMessage"
          disabled="{{isGenerating}}"
        />
        <button class="send-button {{isGenerating ? 'stop-button' : ''}}" bindtap="sendMessage">
          <image class="send-icon" src="{{isGenerating ? '/images/pause.svg' : '/images/send.svg'}}" mode="aspectFit"></image>
        </button>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view wx:if="{{showActionBar}}" class="action-bar">
      <button class="action-bar-btn" bindtap="copySelectedContent">
        <image class="action-icon" src="/images/copy-link.svg" mode="aspectFit"></image>
        <text class="action-text">å¤åˆ¶é“¾æ¥</text>
      </button>
      <button class="action-bar-btn" bindtap="shareToWeChat">
        <image class="action-icon" src="/images/wechat-share.svg" mode="aspectFit"></image>
        <text class="action-text">å¾®ä¿¡åˆ†äº«</text>
      </button>
      <button class="action-bar-btn" bindtap="generateShareImage">
        <image class="action-icon" src="/images/share-long-image.svg" mode="aspectFit"></image>
        <text class="action-text">åˆ†äº«é•¿å›¾</text>
      </button>
    </view>

    <!-- éšè—çš„Canvasç”¨äºç”Ÿæˆåˆ†äº«å›¾ç‰‡ -->
    <canvas
      id="shareCanvas"
      type="2d"
      style="position: fixed; top: -9999px; left: -9999px; width: 750px; height: 1200px;"
    ></canvas>
  </view>
</view>
